<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<h:head>
    <h:outputStylesheet library="css" name="style.css"/>
</h:head>
<h:body>
    <p:growl id="growl" showDetail="true" />
    <table style="width: 100%;">
        <tr>
            <td>
                <h:outputText style="font-weight: bold; font-size: 20px;" value="#{Controller.objectPath}" />
            </td>
            <td width="120" align="center">
                <p:commandButton value="Сохранить" actionListener="#{Controller.saveData}"
                                 update=":tabView :growl" />
            </td>
        </tr>
    </table>
    <p:tabView id="tabView" style="height: 100%; transform: unset;" orientation="bottom">
        <p:tab id="aTab" title="Аналоговые">
            <h:form id="tableForm" style="height: 100%;">
                <p:dataTable id="tableData" var="data" value="#{Controller.tableModel}" rowHover="true" scrollable="true" scrollHeight="100%"
                             editable="true" editMode="cell" rowIndexVar="rowIdx" rowStyleClass="#{data.color}" rowKey="#{data.id}"
                             filteredValue="#{Controller.filteredTableModel}" widgetVar="tableWidget">

                    <p:ajax event="cellEditInit" listener="#{Controller.onCellEditInit}" />
                    <p:ajax event="cellEdit" listener="#{Controller.onCellEdit}" update=":growl" />

                    <p:columnGroup type="header">
                        <p:row>
                            <p:column rowspan="2" headerText="Обозн" width="50"/>
                            <p:column rowspan="2" headerText="Стат.агр." width="150"/>
                            <p:column rowspan="2" headerText="Зона" width="50"/>
                            <p:column rowspan="2" headerText="Техпр" width="50" filterBy="#{data.techProcCode}" filterMatchMode="exact">
                                <f:facet name="filter">
                                    <p:selectOneMenu onchange="PF('tableWidget').filter()" style="width: 50px;">
                                        <f:selectItem itemLabel="-" itemValue="#{null}" noSelectionOption="true" />
                                        <f:selectItems value="#{Controller.techProcFilter}" />
                                    </p:selectOneMenu>
                                </f:facet>
                            </p:column>
                            <p:column rowspan="2" headerText="Ед.изм" width="50"/>
                            <p:column rowspan="2" headerText="График/Опт.знач." width="150"/>
                            <p:column rowspan="2" headerText="Суточное снижение" width="150"/>
                            <p:column colspan="3" headerText="Технологические границы" width="185" />
                            <p:column colspan="4" headerText="Аварийные границы" width="215" />
                        </p:row>
                        <p:row>
                            <p:column headerText="Нижняя" width="80" />
                            <p:column headerText="Верхняя" width="80" />
                            <p:column headerText="%" width="25" />
                            <p:column headerText="Нижняя" width="80" />
                            <p:column headerText="Верхняя" width="80" />
                            <p:column headerText="%" width="25" />
                            <p:column headerText="Отн" width="35" />
                        </p:row>
                    </p:columnGroup>

                    <p:column>
                        <h:outputText id="parMemo" value="#{data.parMemo}" />
                        <p:tooltip for="parMemo" value="#{data.parName}" position="bottom"/>
                    </p:column>

                    <p:column style="white-space: nowrap; text-overflow: ellipsis; max-width: 50px;">
                        <h:outputText id="statAgrName" value="#{data.statAgrName}" />
                        <p:tooltip for="statAgrName" value="#{data.statAgrName}" position="bottom"/>
                    </p:column>

                    <p:column styleClass="centre-column">
                        <h:outputText value="#{data.zone}"/>
                    </p:column>

                    <p:column styleClass="centre-column">
                        <h:outputText value="#{data.techProcCode}"/>
                    </p:column>

                    <p:column styleClass="centre-column">
                        <h:outputText value="#{data.measureName}"/>
                    </p:column>

                    <p:column id="graphColumn" styleClass="#{data.graphColor}"
                              style="white-space: nowrap; text-overflow: ellipsis; max-width: 50px;">
                        <p:cellEditor disabled="#{data.graphDisable}">
                            <f:facet name="output">
                                <h:outputText id="graphValue" value="#{data.graphName}"/>
                            </f:facet>
                            <f:facet name="input">
                                <h:outputText value="#{data.graphName}"/>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>

                    <p:column id="decreaseColumn" styleClass="#{data.decreaseColor}">
<!--                        TODO Попробовать заменить на commandLink-->
                        <p:cellEditor disabled="#{data.decreaseDisable}">
                            <f:facet name="output">
                                <h:outputText id="decreaseValue" value="#{data.decreaseName}"/>
                            </f:facet>
                            <f:facet name="input">
                                <h:outputText value="#{data.decreaseName}"/>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>

                    <p:column styleClass="centre-column #{data.tMinColor}">
                        <p:cellEditor disabled="#{data.tMinDisable}">
                            <f:facet name="output">
                                <h:outputText value="#{data.tMin}" converter="testConverter" />
                            </f:facet>
                            <f:facet name="input">
                                <p:inputText value="#{data.tMin}" converter="testConverter" style="max-width: 60px;" />
                            </f:facet>
                        </p:cellEditor>
                    </p:column>

                    <p:column styleClass="centre-column #{data.tMaxColor}">
                        <p:cellEditor disabled="#{data.tMaxDisable}">
                            <f:facet name="output">
                                <h:outputText value="#{data.tMax}"/>
                            </f:facet>
                            <f:facet name="input">
                                <p:inputText value="#{data.tMax}" style="max-width: 60px;" />
                            </f:facet>
                        </p:cellEditor>
                    </p:column>

                    <p:column styleClass="centre-column">
                        <p:selectBooleanCheckbox disabled="#{data.tPersentDisable}" value="#{data.tPercent}">
                            <p:ajax event="change" listener="#{Controller.onBooleanValueChange(rowIdx)}" />
                        </p:selectBooleanCheckbox>
                    </p:column>

                    <p:column styleClass="centre-column #{data.aMinColor}">
                        <p:cellEditor disabled="#{data.aMinDisable}">
                            <f:facet name="output">
                                <h:outputText value="#{data.aMin}"/>
                            </f:facet>
                            <f:facet name="input">
                                <p:inputText value="#{data.aMin}" style="max-width: 60px;" />
                            </f:facet>
                        </p:cellEditor>
                    </p:column>

                    <p:column styleClass="centre-column #{data.aMaxColor}">
                        <p:cellEditor disabled="#{data.aMaxDisable}">
                            <f:facet name="output">
                                <h:outputText value="#{data.aMax}"/>
                            </f:facet>
                            <f:facet name="input">
                                <p:inputText value="#{data.aMax}" style="max-width: 60px;" />
                            </f:facet>
                        </p:cellEditor>
                    </p:column>

                    <p:column styleClass="centre-column">
                        <p:selectBooleanCheckbox disabled="#{data.aPersentDisable}" id="aPercentColumn" value="#{data.aPercent}">
                            <p:ajax event="change" listener="#{Controller.onBooleanValueChange(rowIdx)}"
                                    update="tabView:tableForm:tableData:#{rowIdx}:absoluteColumn" />
                        </p:selectBooleanCheckbox>
                    </p:column>

                    <p:column styleClass="centre-column">
                        <p:selectBooleanCheckbox disabled="#{data.aPersentDisable}" id="absoluteColumn" value="#{data.absolute}">
                            <p:ajax event="change" listener="#{Controller.onBooleanValueChange(rowIdx)}"
                                    update="tabView:tableForm:tableData:#{rowIdx}:aPercentColumn" />
                        </p:selectBooleanCheckbox>
                    </p:column>
                </p:dataTable>
            </h:form>
        </p:tab>
        <p:tab id="cTab" title="Перечислимые">
            <h:form style="height: 100%; float: left; width: calc(100% - 305px);">
                <p:dataTable id="tableDataCountable" var="data" value="#{Controller.enumerableTableModel}"
                             selection="#{Controller.selectedEnumerateItem}" selectionMode="single" rowKey="#{data.id}"
                             scrollable="true" scrollHeight="100%">
                    <p:ajax event="rowSelect" listener="#{Controller.onRowSelect}" update="tabView:conditionForm"/>

                    <p:column headerText="Параметр" width="70">
                        <h:outputText value="#{data.parMemo}"/>
                    </p:column>
                    <p:column headerText="Стат. агрегат" width="500"
                              style="white-space: nowrap; text-overflow: ellipsis; max-width: 50px;">
                        <h:outputText value="#{data.statAgrName}"/>
                    </p:column>
                    <p:column headerText="Название параметра" width="500"
                              style="white-space: nowrap; text-overflow: ellipsis; max-width: 50px;">
                        <h:outputText value="#{data.parName}"/>
                    </p:column>
                    <p:column styleClass="centre-column" headerText="Зона" width="50">
                        <h:outputText value="#{data.zone}"/>
                    </p:column>
                    <p:column styleClass="centre-column" headerText="Техпр" width="50">
                        <h:outputText value="#{data.techProcCode}"/>
                    </p:column>
                </p:dataTable>
            </h:form>
            <h:form id="conditionForm" style="height: 100%; width: 300px; float: left; margin-left: 5px;">
                <p:dataTable var="condData" value="#{Controller.paramConditionDataModel}" scrollable="true" scrollHeight="100%"
                             editable="true" editMode="cell">
                    <p:ajax event="cellEdit" listener="#{Controller.onCellEnumEdit}" />

                    <p:column headerText="№">
                        <h:outputText value="#{condData.enumCode}"/>
                    </p:column>
                    <p:column headerText="Объект">
                        <h:outputText value="#{condData.propValue}"/>
                    </p:column>
                    <p:column headerText="Технолог">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{condData.condition.name}" />
                            </f:facet>
                            <f:facet name="input">
                                <h:selectOneMenu value="#{condData.cond}" style="width:100%">
                                    <f:selectItems value="#{Controller.conditions}" var="condition"
                                                   itemLabel="#{condition.name}" itemValue="#{condition.condition}" />
                                </h:selectOneMenu>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                </p:dataTable>
            </h:form>
        </p:tab>
    </p:tabView>

    <h:form>
        <p:dialog header="Выберите суточное снижение" widgetVar="decreaseDialog" modal="true"
                  resizable="false" width="600" height="300">
            <div style="height: calc(100% - 5px);">
                <p:dataTable var="decreaseData" value="#{Controller.decreases}" rowKey="#{decreaseData.id}"
                             selectionMode="single" selection="#{Controller.selectDecrease}"
                             scrollable="true" scrollHeight="100%">
                    <p:column headerText="Название" width="150">
                        <h:outputText value="#{decreaseData.name}"/>
                    </p:column>

                    <p:column headerText="Описание">
                        <h:outputText value="#{decreaseData.description}"/>
                    </p:column>
                </p:dataTable>
            </div>

            <f:facet name="footer">
                <p:commandButton value="Выбрать" action="#{Controller.saveDecrease}" onclick="PF('decreaseDialog').hide()"/>
            </f:facet>
        </p:dialog>
    </h:form>

    <h:form id="graphSelectForm" onkeypress="if (event.keyCode === 13) { return false; }">
        <p:dialog header="Выберите график или оптимальное значение" widgetVar="graphDialog" modal="true"
                  resizable="false" width="600" height="300">
            <p:tabView id="gTab" orientation="bottom" style="height: 100%; transform: unset;">
                <p:tab id="gTab1" title="График">
                    <f:facet name="actions">
                        <p:commandButton style="margin-top: 2px;" value="Выбрать" action="#{Controller.saveGraph}"
                                         onstart="document.getElementById('graphSelectForm:gTab:optValue').value = '';"
                                         onclick="PF('graphDialog').hide()"/>
                    </f:facet>

                    <div style="height: calc(100% - 5px);">
                        <p:dataTable var="graphData" value="#{Controller.graphs}" rowKey="#{graphData.id}"
                                     selectionMode="single" selection="#{Controller.selectGraph}"
                                     scrollable="true" scrollHeight="100%">
                            <p:column headerText="Название" width="150">
                                <h:outputText value="#{graphData.name}"/>
                            </p:column>

                            <p:column headerText="Описание">
                                <h:outputText value="#{graphData.description}"/>
                            </p:column>
                        </p:dataTable>
                    </div>
                </p:tab>
                <p:tab id="gTab2" title="Оптимальное значение">
                    <f:facet name="actions">
                        <p:commandButton style="margin-top: 2px;" value="Выбрать" action="#{Controller.saveOptValue}"
                                          validateClient="true" oncomplete="if (!args.validationFailed) PF('graphDialog').hide();"
                                         update="growl"/>
                    </f:facet>

                    <table id="optValueTable" style="width: 100%; margin-top: 50px;">
                        <tr>
                            <td align="left" style="font-weight: bold;">
                                АварН
                            </td>
                            <td align="left" style="font-weight: bold;">
                                ТехН
                            </td>
                            <td align="center" style="font-weight: bold;">
                                Оптимальное значение
                            </td>
                            <td align="right" style="font-weight: bold;">
                                ТехВ
                            </td>
                            <td align="right" style="font-weight: bold;">
                                АварВ
                            </td>
                        </tr>
                        <tr>
                            <td align="left">
                                <h:outputText id="aMin" value="#{Controller.aMin}" />
                            </td>
                            <td align="left">
                                <h:outputText id="tMin" value="#{Controller.tMin}" />
                            </td>
                            <td align="center">
                                <p:inputText id="optValue" value="#{Controller.optValue}" style="text-align: center;">
                                    <p:ajax event="keyup" update="graphSelectForm:gTab:aMin graphSelectForm:gTab:tMin graphSelectForm:gTab:tMax graphSelectForm:gTab:aMax"/>
                                </p:inputText>
                                <h:inputHidden id="hidden">
                                    <f:validator validatorId="rangeValidator" />
                                </h:inputHidden>
                            </td>
                            <td align="right">
                                <h:outputText id="tMax" value="#{Controller.tMax}" />
                            </td>
                            <td align="right">
                                <h:outputText id="aMax" value="#{Controller.aMax}" />
                            </td>
                        </tr>
                    </table>
                </p:tab>
            </p:tabView>
        </p:dialog>
    </h:form>
</h:body>
</html>
